{% extends "layout/basic.html" %}
{% load render_table from django_tables2 %}
{% load bootstrap4 %}
{% load crispy_forms_tags %}
{% load static %}
{% block title %}Статистика{% endblock %}
{% block nav5 %}active{% endblock %}
{% block content %}
<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1>Статистика</h1>
      </div><!-- /.col -->
    </div><!-- /.row -->
  </div><!-- /.container-fluid -->
</div>
    <section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-6">
                <div class="card card-success collapsed-card">
                  <div class="card-header">
                    <h3 class="card-title">Назначения</h3>

                    <div class="card-tools">
                      <button type="button" class="btn btn-tool" data-card-widget="collapse" id="collapse1"><i class="fas fa-plus"></i>
                      </button>
                      <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
                    </div>
                  </div>
                  <div class="card-body">

                  </div>
                  <!-- /.card-body -->
                </div>
                <div class="card">
                  <div class="card-header">
                        <h3 class="card-title">Отчеты</h3>
                    <div class="card-tools">
                      <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i>
                      </button>
                      <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="row">
                            <div class="col-md-3">
                                <button type="button" class="btn btn-block bg-gradient-success btn-lg" data-toggle="modal" data-target="#modal-report1">Определенный период</button>
                            </div>
                             <div class="col-md-2">
                                <button type="button" class="btn btn-block bg-gradient-success btn-lg" data-toggle="modal" data-target="#modal-report2">Ещё какой нибудь отчет</button>
                            </div>
                             <div class="col-md-2">

                            </div>
                         </div>
                  </div>
                  <!-- /.card-body -->
                </div>
            </div>
            <div class="col-md-6">
                <div class="card card-warning collapsed-card">
                  <div class="card-header">
                    <h3 class="card-title">Жалобы</h3>
                    <div class="card-tools">
                      <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-plus"></i>
                      </button>
                      <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="chart">
                        <div class="chartjs-size-monitor">
                            <div class="chartjs-size-monitor-expand">
                                <div class="">

                                </div>
                            </div>
                            <div class="chartjs-size-monitor-shrink">
                                <div class="">

                                </div>
                            </div>
                        </div>
                      <canvas id="barChart1" ></canvas>
                    </div>
                  </div>
                  <!-- /.card-body -->
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal -->
<div class="modal fade" id="modal-report1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Отчет жалоб за определенный период</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
        <form role="form" action="{% url 'api_report' %}" method="post" id="report1">
        {% csrf_token %}
        <div class="modal-body">
            <div class="row">
              <div class="col">
                <div id="div_id_date" class="form-group">
                  <label for="id_date" class="">Дата создания жалобы от<span class="asteriskField">*</span></label>
                  <div class="">
                    <input type="date" name="date" maxlength="50" class="textinput textInput form-control" id="id_date_from" required>
                    <small id="hint_id_date"></small>
                  </div>
                </div>
              </div>
                <div class="col">
                <div id="div_id_date" class="form-group">
                  <label for="id_date" class="">Дата создания жалобы до<span class="asteriskField">*</span></label>
                  <div class="">
                    <input type="date" name="date" maxlength="50" class="textinput textInput form-control" id="id_date_before" required>
                    <small id="hint_id_date"></small>
                  </div>
                </div>
              </div>
            </div>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
          <button type="submit" class="btn btn-primary">Запросить</button>
        </div>
        </form>
    </div>
    <!-- /.modal-content -->
  </div>
  <!-- /.modal-dialog -->
</div>
<!-- /.modal -->
{% endblock %}
{% block ends %}
    <script>
$(function () {
    var areaChartData2 = {
      labels  : ['{{ dates.plus.0 }}', '{{ dates.plus.1 }}', '{{ dates.plus.2 }}', '{{ dates.plus.3 }}',
                '{{ dates.plus.4 }}', '{{ dates.plus.5 }}', '{{ dates.plus.6 }}'],
      datasets: [
        {
          label               : 'Количество жалоб подходящий срок ответа',
          backgroundColor     : 'rgba(60,141,188,0.9)',
          borderColor         : 'rgba(60,141,188,0.8)',
          pointRadius          : false,
          pointColor          : '#3b8bba',
          pointStrokeColor    : 'rgba(60,141,188,1)',
          pointHighlightFill  : '#fff',
          pointHighlightStroke: 'rgba(60,141,188,1)',
          data                : [{{ kolvo.problems.0 }}, {{ kolvo.problems.1 }}, {{ kolvo.problems.2 }}, {{ kolvo.problems.3 }},
                                {{ kolvo.problems.4 }}, {{ kolvo.problems.5 }}, {{ kolvo.problems.6 }}]
        }
      ]
    };

    var areaChartOptions = {
      maintainAspectRatio : false,
      responsive : true,
      legend: {
        display: false
      },
      scales: {
        xAxes: [{
          gridLines : {
            display : false,
          }
        }],
        yAxes: [{
          gridLines : {
            display : false,
          }
        }]
      }
    };

    //-------------
    //- BAR CHART -
    //-------------

    var barChartCanvas2 = $('#barChart1').get(0).getContext('2d')
    var barChartData2 = jQuery.extend(true, {}, areaChartData2)
    var temp1 = areaChartData2.datasets[0]
    barChartData2.datasets[0] = temp1

    var barChart2 = new Chart(barChartCanvas2, {
      type: 'bar',
      data: barChartData2,
      options: barChartOptions
    })
  });

$('#collapse1').click(function () {
    var url = '{% url 'dashboard' %}',
            CSRFtoken = jQuery("[name=csrfmiddlewaretoken]").val();
        var posting = $.post( url, {csrfmiddlewaretoken: CSRFtoken, chart: '1'}, Collapsef1);
});

function Collapsef1(data)
{
    
    <div class="chart">
        <div class="chartjs-size-monitor">
            <div class="chartjs-size-monitor-expand">
                <div class="">

                </div>
            </div>
            <div class="chartjs-size-monitor-shrink">
                <div class="">

                </div>
            </div>
        </div>
      <canvas id="barChart" ></canvas>
    </div>
    var areaChartData = {
      labels  : data['label'],
      datasets: [
        {
          label               : 'Количетсво созданных назначений',
          backgroundColor     : 'rgba(60,141,188,0.9)',
          borderColor         : 'rgba(60,141,188,0.8)',
          pointRadius          : false,
          pointColor          : '#3b8bba',
          pointStrokeColor    : 'rgba(60,141,188,1)',
          pointHighlightFill  : '#fff',
          pointHighlightStroke: 'rgba(60,141,188,1)',
          data                : data['data']
        }
      ]
    };

    var barChartCanvas = $('#barChart').get(0).getContext('2d')
    var barChartData = jQuery.extend(true, {}, areaChartData)
    var temp0 = areaChartData.datasets[0]
    barChartData.datasets[0] = temp0

    var barChartOptions = {
      responsive              : true,
      maintainAspectRatio     : false,
      datasetFill             : false
    };

    var barChart = new Chart(barChartCanvas, {
      type: 'bar',
      data: barChartData,
      options: barChartOptions
    });
}


$('#report1').submit(function (event) {
        event.preventDefault();
        var $form = $( this ),
            datefrom = $form.find('input[id="id_date_from"]').val(),
            datebefore = $form.find('input[id="id_date_before"]').val(),
            url = $form.attr( 'action' ),
            CSRFtoken = $('input[name=csrfmiddlewaretoken]').val();
        var posting = $.post( url, {csrfmiddlewaretoken: CSRFtoken, datefrom: datefrom, datebefore: datebefore, report: '1'}, onAjaxSuccess);
        $('#modal-report1').modal('hide');
    });

function onAjaxSuccess(data)
{
    const dummy = document.createElement('a');
    dummy.href = data['url'];
    {#dummy.download = 'my-filename.ext';#}

    document.body.appendChild(dummy);
    dummy.click();
    dummy.remove()
    if (data['nom'] == 0) {
        toastr["success"](data['message'], data['title'])
    } else {
        toastr["error"](data['message'], data['title'])
    }
}
    </script>
{% endblock %}